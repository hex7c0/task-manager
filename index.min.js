"use strict";function resume(a){return a.resume()}function wrapper(a){function b(b){d.listen(a.listen,function(){b&&console.log("task manager bound at "+a.listen)})}var c=function(){};a.output&&(c=function(a){return console.log(a)});var d=net.createServer(function(b){var e=!1;b.on("end",function(){return a.auth&&(e=!1),c("client disconnected")}),b.on("data",function(f){b.pause();var g=String(f);if(a.auth&&e===!1)return g.replace(/(\n)*(\r)*/g,"")===a.auth?(e=!0,b.write("> hello master\n",function(){c("client connected")})):b.write("> auth required\n",function(){c("client denied")}),resume(b);var h,i,j=cluster.workers;if(/^(kill|swap)/.test(g)){if(i=g.match(/[0-9]+\n/),i&&(i=Number(i[0]))){for(var k in j)if(h=j[k],h.process.pid===i)return h.kill(),b.write("> "+i+" killed\n"),resume(b);return b.write("> child's pid not found\n"),resume(b)}var l=0;for(var m in j)j[m].kill(),l++;return b.write("> "+l+" killed\n"),resume(b)}if(/^disconnect/.test(g)){if(i=g.match(/[0-9]+\n/),i&&(i=Number(i[0])))for(var n in j)if(h=j[n],h.process.pid===i){h.disconnect();var o=setTimeout(function(){return h.kill()},5e3);return h.on("disconnect",function(){return clearTimeout(o)}),b.write("> "+i+" disconnect\n"),resume(b)}return b.write("> child's pid not found\n"),resume(b)}if(/^fork[\r]?\n/.test(g))return i=cluster.fork(),b.write("> "+i.process.pid+" forked\n"),resume(b);if(/^ps[\r]?\n/.test(g)){var p="> father pid: "+process.pid+"\n";for(var q in j)p+="> child pid: "+j[q].process.pid+"\n";return b.write(p),resume(b)}return/^(quit|exit)[\r]?\n$/.test(g)?(b.end("> goodbye\n",function(){return d.close(function(){return c("shutting down")})}),process.exit(0)):/^close[\r]?\n$/.test(g)?b.end("> bye\n",function(){return d.close(function(){return c("closing task-manager")})}):/^help[\r]?\n$/.test(g)?(b.write("  kill|swap [pid]\n"),b.write("  disconnect pid\n"),b.write("  fork\n"),b.write("  ps\n"),b.write("  quit|exit\n"),b.write("  close\n"),resume(b)):a.custom&&a.custom.test(g)?(a.callback(b,g),resume(b)):(b.write('> unrecognized, try "help"\n'),resume(b))}),a.auth?e?b.write("> hello master\n",function(){return c("client connected")}):b.write("> auth required\n"):b.write("> hello master\n")});d.on("error",function(c){"EADDRINUSE"===c.code&&(isNaN(a.listen)?unlink(a.listen,function(a){if(a)throw a;b(!1)}):setTimeout(function(){b(!1)},1e3))}),b(!0)}function task(a,b){if(!a)throw new TypeError("listen required");var c=Number(a)||String(a),d=b||Object.create(null),e={listen:c,output:d.output===!0?!0:!1,auth:Boolean(d.auth)?String(d.auth):!1,custom:Boolean(d.custom)?d.custom:!1,callback:d.callback};return e.custom&&"function"==typeof e.callback?e.custom.source||(e.custom=new RegExp(e.custom)):e.custom=!1,wrapper(e)}try{var cluster=require("cluster"),unlink=require("fs").unlink,net=require("net")}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}module.exports=task;
